<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<header>
    <div th:replace="~{fragments/header :: header}"></div>

</header>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container">

    <div class="pagination-controls" style="margin:1rem 0 1rem 0;">

        <a th:href="@{'/charts/categories/' + ${category.id} + '?year=' + ${prevYear}}" class="myButton">Previous
            Year</a>
        <span th:text="${currentYear}"></span>
        <a th:href="@{'/charts/categories/' + ${category.id} + '?year=' + ${nextYear}}" class="myButton">Next Year</a>

    </div>

    <canvas id="chart" class="chart-canvas" margin="1rem"></canvas>


    <script th:inline="javascript">

    /* Retrieve the data from the server-side */
    var labels = /*[[${labels}]]*/ [];
    var credits = /*[[${credits}]]*/ [];
    var debits = /*[[${debits}]]*/ [];

    /* Calculate the total income */
    var totalIncome = credits.reduce((a, b) => a + b, 0);

    /* Create the chart */
    var ctx = document.getElementById('chart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Debits',
                data: debits,
                backgroundColor: 'rgba(244, 164, 164, 0.5)', // #f4a4a4 at 50% opacity
                borderColor: 'rgb(244, 164, 164)', // #f4a4a4
                borderWidth: 1,
                stack: 'stack1' // Assign the same stack ID to both datasets
            }, {
                label: 'Credits',
                data: credits,
                backgroundColor: 'rgba(100, 116, 229, 0.5)', // #6474e5 at 50% opacity
                borderColor: 'rgb(100, 116, 229)', // #6474e5
                borderWidth: 1,
                stack: 'stack1' // Assign the same stack ID to both datasets
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    grid: {
                        display: false
                    }
                },
                y: {
                    beginAtZero: true,
                    stacked: true,
                    ticks: {
                        callback: function (value) {
                            return new Intl.NumberFormat('en-US', {
                                style: 'currency',
                                currency: 'USD'
                            }).format(value);
                        },
                        max: totalIncome // Set the maximum value to the total income
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            var label = context.dataset.label || '';

                            if (label) {
                                label += ': ';
                            }

                            if (context.parsed !== null) {
                                var total = context.chart.data.datasets.reduce(function (acc, dataset) {
                                    return acc + dataset.data[context.dataIndex];
                                }, 0);
                                var value = context.dataset.data[context.dataIndex];
                                var percentage = ((value / total) * 100).toFixed(2) + '%';
                                label += new Intl.NumberFormat('en-US', {
                                    style: 'currency',
                                    currency: 'USD'
                                }).format(value) + ' (' + percentage + ')';
                            }

                            return label;
                        }
                    }
                }
            },
            onClick: function (event, array) {
                if (array.length > 0) {
                    var label = labels[array[0].index];
                    window.location.href = '/chart/' + label;
                }
            }
        }
    });

</script>


</div>
</body>
</html>

