<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<header>
    <div th:replace="~{fragments/header :: header}"></div>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <script>
function submitAllocations() {
    // Get the current month and year from the URL
    const urlParts = window.location.pathname.split('/');
    const monthYear = urlParts[urlParts.length - 1];

    // Create an array to store all the savings entities
    let savingsEntities = [];



// Get all the sliders
const sliders = document.getElementsByClassName('slider');
for (let i = 0; i < sliders.length; i++) {
    // Get the current slider
    let slider = sliders[i];

    // Get the associated goal
    let goalName = slider.id.replace('Slider', '');
    let goalDivs = document.querySelectorAll('.goal');
    let goalDiv = Array.from(goalDivs).find((element) => element.querySelector('p').textContent.trim() === goalName);

    // Check if the goal element exists
    if (goalDiv) {
        // Get goal id from the data attribute
        let goalId = goalDiv.getAttribute('data-goal-id');

        // Create a savings entity for this slider
        let savingsEntity = {
            goalId: goalId,
            amount: slider.value
        };

        // Add the savings entity to the array
        savingsEntities.push(savingsEntity);
    } else {
        console.error(`Goal element not found for ${goalName}`);
    }
}



    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeaderName = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    // Convert the array to JSON
    let jsonData = JSON.stringify(savingsEntities);

    // Create the URL with the formatted month and year
    const url = `/savings/allocate-savings/${encodeURIComponent(monthYear)}`;

    // Send the data to the server-side
    fetch(url, {
        method: 'POST',
        body: jsonData,
        headers: {
            'Content-Type': 'application/json',
            [csrfHeaderName]: csrfToken
        }
    })
        .then((response) => {
            if (response.ok) {
                alert('Allocation saved!');
            } else {
                alert('Failed to save allocation!');
            }
        })
        .catch((error) => {
            console.error('Error:', error);
        });
}
    </script>

    </script>
</header>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container">

    <h1>Allocate your funds</h1>

    <h2 th:text${monthToAllocate}></h2>

    <div th:each="goal : ${goals}" class="goal" th:data-goal-id="${goal.id}">
        <p th:text="${goal.name}"></p>
        <div class="slider-container">
            <input type="range" min="0" th:attr="max=${goal.maxAmount}, value=0" class="slider"
                   th:id="${goal.name + 'Slider'}">
            <p class="amount" th:id="${goal.name + 'Amount'}" th:text="0"></p>
        </div>
    </div>

    <p>Total allocated: <span id="totalAllocated" th:text="${totalAllocated}"></span> / <span id="totalToAllocate"
                                                                                              th:text="${totalToAllocate}"></span>
    </p>

    <button onclick="submitAllocations()">Save</button>


    <script th:inline="javascript">
  let totalAllocated = document.getElementById("totalAllocated");
  let goalContainers = document.getElementsByClassName("slider-container");

  function updateColor(slider) {
    let value = slider.value;
    if (value < 49) {
      slider.style.background = "#f44336"; // Red
    } else if (value >= 49 && value <= 51) {
      slider.style.background = "#ffeb3b"; // Yellow
    } else {
      slider.style.background = "#4caf50"; // Green
    }
  }

  function updateAmount(slider, amount) {
    let value = slider.value;
    amount.textContent = value;
  }

  function updateTotalAllocated() {
    let total = 0;
    for (let container of goalContainers) {
      let slider = container.getElementsByClassName("slider")[0];
      total += Number(slider.value);
    }
    totalAllocated.textContent = total.toFixed(2);
    if (total === /*[[${totalToAllocate}]]*/) {
      totalAllocated.style.color = "#4caf50"; // Green
    } else {
      totalAllocated.style.color = "#f44336"; // Red
    }
  }

  for (let container of goalContainers) {
    let slider = container.getElementsByClassName("slider")[0];
    let amount = container.getElementsByClassName("amount")[0];
    slider.oninput = function() {
      updateColor(slider);
      updateAmount(slider, amount);
      updateTotalAllocated();
    };
  }



    </script>


</div>


</body>
</html>
